版本: 1.0
说明: 本测试文档反向约束开发文档中的每一步。每个测试项包含：测试目标、前置条件、测试执行步骤、通过标准。测试编号为开发步骤的验收锚点。

目录（主要测试项）
1. 项目初始化与目录结构
  1.1 初始化：父 POM 与模块结构搭建验证
  1.2 目录与分层一致性测试

2. 数据库设计与迁移
  2.1 DDL 正确性测试（表/字段/基本约束）
  2.2 索引与外键、迁移回滚测试

3. API 设计与契约
  3.1 OpenAPI/Swagger 与实现一致性测试
  3.2 统一响应/错误处理测试

4. 核心业务功能测试
  4.1 认证（JWT）功能测试
  4.2 RBAC 权限控制测试
  4.3 文档导入（Ingest）与 Embedding 写入测试

5. RAG 能力逐阶段测试
  5.1 Phase1：基础 RAG 测试（向量检索 + LLM 回答链）
  5.2 Phase2：混合检索有效性测试（向量+关键词）
  5.3 Phase3：Re-rank 功能正确性与效果测试
  5.4 Phase4：多轮对话上下文保全测试

6. 中间件与基础设施测试
  6.1 Docker Compose 中间件可复现性测试（MySQL/Redis/Milvus/RabbitMQ/Ollama）
  6.2 部署与运行文档可执行性测试

7. 前端契约与集成测试
  7.1 Login 与鉴权流程测试（前端-后端契约）
  7.2 搜索页面与结果契约一致性测试

每项测试内容详述：

1.1 初始化：父 POM 与模块结构搭建验证
- 测试目标：验证项目存在父 POM，Maven 多模块能在本地构建，且模块划分与开发文档一致。
- 前置条件：代码仓库已 clone；JDK 17 与 Maven 安装。
- 执行步骤：
  1. mvn -f pom.xml clean install
  2. 确认 backend-app、backend-domain 等模块被构建并产出 artifact。
  3. 检查 `docs/design` 中列出的模块目录是否存在。
- 通过标准：构建成功（exit 0），且目录结构与开发文档完全一致（文件/包名匹配）。

1.2 目录与分层一致性测试
- 测试目标：验证代码分层（controller/service/repository/infra）与开发文档一致。
- 前置条件：仓库代码可访问。
- 执行步骤：
  1. 静态扫描或人工检查各模块 package 是否包含至少 controller/service/repository。
  2. 随机抽检 3 个 controller，确认其调用链仅限于 service 层（不直接调用 repository/infrastructure）。
- 通过标准：分层一致，且没有跨层直接引用违例。

2.1 DDL 正确性测试（表/字段/基本约束）
- 测试目标：验证 `db/migrations` 中 DDL 可在 MySQL 8 上执行并能创建预期表结构。
- 前置条件：MySQL 8 容器可用，具备执行权限。
- 执行步骤：
  1. 在空数据库中运行 migrations 脚本。
  2. 使用 DESCRIBE/INFORMATION_SCHEMA 验证表与字段、主键、NOT NULL。
- 通过标准：所有核心表（用户、文档、embedding 记录、权限表）存在且字段/类型匹配设计。

2.2 索引与外键、迁移回滚测试
- 测试目标：验证索引/外键存在，且迁移具备回滚脚本。
- 前置条件：2.1 已通过。
- 执行步骤：
  1. 检查索引存在性与性能建议（至少主查询字段上有索引）。
  2. 执行回滚脚本并确认回到初始状态。
- 通过标准：索引和外键存在且回滚成功（数据/表结构回退）。

3.1 OpenAPI/Swagger 与实现一致性测试
- 测试目标：验证 `docs/api/openapi.yaml` 中定义的接口与实际实现行为一致。
- 前置条件：应用运行（本地启动）。
- 执行步骤：
  1. 打开 Swagger UI，逐一调用主要接口（Auth/Login、Search、Document Import）。
  2. 对比请求/响应字段与 OpenAPI 定义。
- 通过标准：所有接口的请求/响应字段与 OpenAPI 定义一致；状态码语义一致。

3.2 统一响应/错误处理测试
- 测试目标：验证统一响应结构与错误码映射。
- 前置条件：应用运行。
- 执行步骤：
  1. 触发已定义错误（例如参数校验失败、权限不足、资源不存在）。
  2. 查看返回体，确认包含标准错误码与错误描述。
- 通过标准：错误返回符合统一格式；错误码可查表定位问题。

4.1 认证（JWT）功能测试
- 测试目标：验证登录、Token 签发、刷新、失效逻辑。
- 前置条件：用户表有测试用户（通过 migration 或脚本创建）。
- 执行步骤：
  1. 调用登录接口获取 JWT。
  2. 使用 JWT 调用受保护接口。
  3. 模拟 Token 过期或伪造，验证访问被拒绝。
- 通过标准：合法 Token 通过访问；过期/伪造 Token 被拒绝；刷新 Token 工作正常。

4.2 RBAC 权限控制测试
- 测试目标：验证不同角色访问不同资源权限控制。
- 前置条件：存在至少两种角色（admin/normal）并分配给测试用户。
- 执行步骤：
  1. 使用普通用户 Token 调用仅 admin 可访问接口，确认返回 403。
  2. 使用 admin Token 调用并通过。
- 通过标准：权限校验按角色生效，拒绝与允许行为符合预期。

4.3 文档导入（Ingest）与 Embedding 写入测试
- 测试目标：验证导入流程能生成 Embedding 并写入 Milvus，且在 DB 中生成元数据记录。
- 前置条件：Milvus 服务可用，Ollama Embedding 接口 stub/可用。
- 执行步骤：
  1. 上传或提交示例文档执行 ingest API。
  2. 检查 DB 中 document/embedding 记录；检查 Milvus 中是否存在对应向量（或通过返回的 ID 验证）。
- 通过标准：导入流程完成并返回 success；DB 与 Milvus 存在对应记录。

5.1 Phase1：基础 RAG 测试
- 测试目标：验证通过向量检索到相关片段并能调用 LLM 返回合理答案。
- 前置条件：已导入文档并生成 Embedding，Ollama LLM 可调用（真实或 stub）。
- 执行步骤：
  1. 调用 Search 接口提交自然语言问题。
  2. 查看检索结果、LLM 调用记录与最终回答。
- 通过标准：检索返回相关片段，LLM 返回有答案且接口链路（检索→LLM）无错误。

5.2 Phase2：混合检索有效性测试
- 测试目标：验证混合检索（向量+关键词）在常见查询上提升召回/准确率。
- 前置条件：同 5.1。
- 执行步骤：
  1. 对比同一查询在仅向量检索和混合检索下的候选集。
  2. 评估命中率并记录差异。
- 通过标准：混合检索在至少 3 个示例查询中表现优于单一向量检索（可通过人工判断或简单评分判定）。

5.3 Phase3：Re-rank 功能正确性测试
- 测试目标：验证 Re-rank 能对候选答案进行质量提升（相对排序改进）。
- 前置条件：LLM 可用作为 re-ranker。
- 执行步骤：
  1. 收集候选段落集合，运行 Re-rank 模块，比较排序前后结果。
  2. 使用人工或自动化评分判断是否提升。
- 通过标准：在大多数示例下，Re-rank 后的首位候选与人工期望更一致。

5.4 Phase4：多轮对话上下文保全测试
- 测试目标：验证会话上下文在多轮交互中被正确保留与截断/摘要。
- 前置条件：ConversationManager 已实现。
- 执行步骤：
  1. 进行多轮问答（5+ 轮），在中途插入需要上下文支持的问题。
  2. 检查回答是否使用先前上下文并合理应对上下文容量限制。
- 通过标准：多轮对话能保持上下文，且在超过窗口时执行截断或摘要策略不导致错误。

6.1 Docker Compose 中间件可复现性测试
- 测试目标：验证 `infra/docker-compose.yml` 可一键启动 MySQL/Redis/Milvus/RabbitMQ/Ollama（或其 stub）。
- 前置条件：Docker 与 Docker Compose 可用。
- 执行步骤：
  1. docker-compose up -d
  2. 检查各容器健康状态与端口暴露。
- 通过标准：所有必要容器正常运行且可连通（端口可访问）。

6.2 部署与运行文档可执行性测试
- 测试目标：验证 `docs/deploy.md` 文档描述的部署步骤可复现。
- 前置条件：按文档准备环境。
- 执行步骤：
  1. 按文档步骤启动服务。
  2. 记录任何遗漏项或不一致之处。
- 通过标准：按文档步骤可在目标环境成功启动服务。

7.1 前端 Login 与鉴权流程测试
- 测试目标：验证前端调用后端登录接口并正确存储/使用 JWT。
- 前置条件：后端 auth 接口可用。
- 执行步骤：
  1. 在前端输入测试用户凭证，检查是否获取 Token 并存储（localStorage/sessionStorage）。
  2. 前端调用受保护 API，确认附带 Authorization header 并成功访问。
- 通过标准：登录流程可用，受保护 API 访问成功。

7.2 搜索页面与结果契约一致性测试
- 测试目标：前端展示的数据字段与后端接口返回的一致。
- 前置条件：后端 Search API 可用。
- 执行步骤：
  1. 前端发起搜索请求并渲染结果。
  2. 对比渲染字段与 OpenAPI 定义。
- 通过标准：前端渲染字段与 API 定义一致，异常情况有友好错误提示。

附：测试流程与责任划分
- 单元测试：开发者在提交 PR 前通过（覆盖关键业务逻辑）。
- 集成测试：CI 在 PR 阶段运行（包含 DB/Redis 对接的集成测试，Milvus/Ollama 可用 stub）。
- 端到端/验收测试：在 staging 环境运行，覆盖 4.1/4.3/5.1 等关键路径。
- 验收合格：所有对应测试点通过（Dev 文档中每步引用的测试项都必须通过）。

结语
- 本测试文档是开发文档的唯一验收锚点。任何功能在没有对应测试通过前不得宣称完成。
- 若测试失败，必须在 Issue 中记录失败原因、修复计划与预计完成时间，并重新执行对应测试项。


